name: Quibble

on:
  - push
  - pull_request

jobs:

  quibble:

    strategy:
      matrix:
        mediawiki-version: [REL1_35]

    env:
      MEDIAWIKI_VERSION: ${{ matrix.mediawiki-version }}
      DEPENDENCIES: >-
        mediawiki/extensions/Echo
        mediawiki/extensions/Flow
        mediawiki/extensions/Renameuser

    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2

    - name: Get MediaWiki installation cache
      uses: actions/cache@v2
      id: cache
      with:
        path: src
        key: "${{ runner.os }}-${{ env.MEDIAWIKI_VERSION }}"

    - name: Get dependencies cache
      uses: actions/cache@v2
      with:
        path: cache
        key: "${{ runner.os }}-${{ env.MEDIAWIKI_VERSION }}-${{ hashFiles('**/*.lock') }}"

    - name: Make directories
      run: |
        mkdir "${HOME}"/quibble
        cd "${HOME}"/quibble
        mkdir -p cache log
        chmod 777 cache log

    - name: Download MediaWiki and extensions
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        cd "${HOME}"/quibble
        git clone -b "${MEDIAWIKI_VERSION}" --depth 1 https://gerrit.wikimedia.org/r/mediawiki/core src
        git clone -b "${MEDIAWIKI_VERSION}" --depth 1 https://gerrit.wikimedia.org/r/mediawiki/skins/Vector src/skins/Vector
        for dep in $DEPENDENCIES; do
          git clone -b "${MEDIAWIKI_VERSION}" --depth 1 "https://gerrit.wikimedia.org/r/${dep}" src/extensions/"$(echo $dep | cut -d'/' -f3)"; done

    - name: Move our extension
      run: |
        cp -r "${GITHUB_WORKSPACE}" "${HOME}/quibble/src/extensions/"

    - name: Run Quibble
      run: |
        cd "${HOME}"/quibble
        chmod 777 src
        find src -mindepth 1 -exec sudo chown nobody:nogroup {} \;
        docker run \
          -v "$(pwd)"/cache:/cache \
          -v "$(pwd)"/log:/workspace/log \
          -v "$(pwd)"/src:/workspace/src \
          docker-registry.wikimedia.org/releng/quibble-stretch-php73:latest \
          --packages-source composer \
          --skip-zuul \
          --run composer-test \
          "${DEPENDENCIES}"
